name: Revisar/Crear Data Factory

on:
  workflow_call:
    inputs:
      location:
        required: false
        default: "eastus"
        type: string
    outputs:
      factory-status:
        value: ${{ jobs.check_create.outputs.factory-status }}

jobs:
  check_create:
    runs-on: self-hosted
    outputs:
      factory-status: ${{ steps.set-status.outputs.factory-status }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Leer parÃ¡metros desde datosadf.json
        id: load-json
        shell: pwsh
        run: |
          $json = Get-Content "./datosadf.json" | ConvertFrom-Json
          echo "DATAFACTORY_NAME=$($json.dataFactoryName)" >> $env:GITHUB_ENV
          echo "RESOURCE_GROUP=$($json.resourceGroup)" >> $env:GITHUB_ENV

      - name: Verificar si existe Data Factory
        id: verify
        shell: pwsh
        run: |
          try {
            $factory = az datafactory factory show `
              --name $env:DATAFACTORY_NAME `
              --resource-group $env:RESOURCE_GROUP `
              --only-show-errors `
              --output json | ConvertFrom-Json

            if ($factory) {
              echo "exists=true" >> $env:GITHUB_ENV
            }
          }
          catch {
            echo "exists=false" >> $env:GITHUB_ENV
          }

      - name: Crear Data Factory si no existe
        if: env.exists == 'false'
        shell: pwsh
        run: |
          echo "No existe el Data Factory, se procede a crearlo..."
          az datafactory factory create `
            --name $env:DATAFACTORY_NAME `
            --resource-group $env:RESOURCE_GROUP `
            --location "${{ inputs.location }}" `
            --output none

      - name: Setear estado como output
        id: set-status
        shell: pwsh
        run: |
          if ("${{ env.exists }}" -eq "true") {
            echo "factory-status=exists" >> $env:GITHUB_OUTPUT
          }
          else {
            echo "factory-status=created" >> $env:GITHUB_OUTPUT
          }
