name: Conexion a Azure desde Vault

on:
  workflow_dispatch:

jobs:
  test-vault-azure:
    runs-on: self-hosted
    env:
      VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
      VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. Leer credenciales desde Vault
      - name: Read Azure creds from Vault
        shell: bash
        run: |
          vault kv get -format=json secret/azure-creds > azure-creds.json
          export ARM_CLIENT_ID=$(jq -r '.data.data.ARM_CLIENT_ID' azure-creds.json)
          export ARM_CLIENT_SECRET=$(jq -r '.data.data.ARM_CLIENT_SECRET' azure-creds.json)
          export ARM_SUBSCRIPTION_ID=$(jq -r '.data.data.ARM_SUBSCRIPTION_ID' azure-creds.json)
          export ARM_TENANT_ID=$(jq -r '.data.data.ARM_TENANT_ID' azure-creds.json)

      # 2. Azure login usando las credenciales recuperadas
      - name: Azure login
        shell: bash
        run: |
          az login --service-principal \
            -u "$ARM_CLIENT_ID" \
            -p "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID"

      # 3. Ver suscripci√≥n activa
      - name: Check Azure subscription
        shell: bash
        run: az account show
