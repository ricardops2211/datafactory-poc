name: Azure Login desde Vault (Windows Self-Hosted)

on:
  push:
    branches:
      - datafactory-1

jobs:
  azure-login:
    runs-on: self-hosted # Etiquetas de tu runner, ajusta si la etiqueta es distinta
    steps:
      # 1. Checkout del código
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. Configurar variables de Vault
      - name: Configurar entorno Vault
        shell: powershell
        run: |
          $env:VAULT_ADDR = "${{ secrets.VAULT_ADDR }}"
          $env:VAULT_TOKEN = "${{ secrets.VAULT_TOKEN }}"

      # 3. Obtener credenciales desde Vault y conectarse a Azure
      - name: Obtener credenciales de Azure desde Vault y conectarse
        shell: powershell
        run: |
          # Obtener secretos de Vault en formato JSON
          vault kv get -format=json secret/azure-creds | Out-File -FilePath azure-creds.json -Encoding utf8

          # Parsear el JSON
          $json = Get-Content azure-creds.json | ConvertFrom-Json
          $env:ARM_CLIENT_ID     = $json.data.data.ARM_CLIENT_ID
          $env:ARM_CLIENT_SECRET = $json.data.data.ARM_CLIENT_SECRET
          $env:ARM_SUBSCRIPTION_ID = $json.data.data.ARM_SUBSCRIPTION_ID
          $env:ARM_TENANT_ID     = $json.data.data.ARM_TENANT_ID

          # Login en Azure con Service Principal
          az login --service-principal `
            -u $env:ARM_CLIENT_ID `
            -p $env:ARM_CLIENT_SECRET `
            --tenant $env:ARM_TENANT_ID

          # Mostrar la suscripción activa
          az account show --output table
